import os
import pandas as pd
import geopandas as gpd
pd.options.display.max_columns = None
pd.options.display.max_rows = None


os.chdir("../../data/intermediate/")

# get all the gaps
gaps_merged = pd.DataFrame()
#gpd.read_file("exposure_aggregated_2013.gpkg")[["NUTS_ID", "NUTS_NAME", "geometry"]]

# relative gaps
for yoi in range(2013,2023):
    yoi = str(yoi)
    temp = gpd.read_file("exposure_aggregated_" + yoi + ".gpkg")
    temp2 = temp.loc[:,temp.columns.str.startswith("rel_gap")]
    temp2["NUTS_ID"] = temp["NUTS_ID"].copy()
    temp2["year"] = yoi
    gaps_merged = gaps_merged.append(temp2)

gaps_merged.to_csv("../processed/rel_gap_table.csv")
#exposure_merged.to_file("D:/LocalData/SpreeCase/exposure/exposure_all.gpkg", diver="GPKG")
#pd.DataFrame(exposure_merged).drop("geometry", axis=1).to_csv("D:/LocalData/SpreeCase/exposure/exposure_table.csv")


# absolute values
for yoi in range(2013,2023):
    yoi = str(yoi)
    temp = gpd.read_file("exposure_aggregated_" + yoi + ".gpkg")
    temp2 = temp.loc[:,temp.columns.str.startswith("adj_gap")]
    temp2["NUTS_ID"] = temp["NUTS_ID"].copy()
    temp2["year"] = yoi
    gaps_merged = gaps_merged.append(temp2)

gaps_merged.to_csv("../processed/gap_table.csv")





# initialize the merged dataframes with the geometry and the NUTS_ID
loss_merged = gpd.read_file("loss_estimates_2013.gpkg")[["NUTS_ID", "NUTS_NAME", "geometry"]]
aloss_merged = gpd.read_file("loss_estimates_2013.gpkg")[["NUTS_ID", "NUTS_NAME", "geometry"]]

for yoi in range(2013,2023):
    yoi = str(yoi)
    temp = gpd.read_file("loss_estimates_" + yoi + ".gpkg")
    temp = temp.rename(columns={"adj_loss_relative": "aloss"+yoi,
                                "adj_loss_estimate_total": "loss"+yoi})
    loss_merged = loss_merged.merge(temp[["NUTS_ID", "loss"+yoi]])
    aloss_merged = aloss_merged.merge(temp[["NUTS_ID", "aloss"+yoi]])

loss_merged.to_file("loss.gpkg", diver="GPKG")
aloss_merged.to_file("aloss.gpkg", diver="GPKG")


# gpkg to csv
pd.DataFrame(loss_merged).drop("geometry", axis=1).to_csv("loss_table.csv")
pd.DataFrame(aloss_merged).drop("geometry", axis=1).to_csv("aloss_table.csv")

