library(sf)
library(dplyr)

data = read.csv("./data/raw/sodoge_drought_impact_dataset.csv")
shapes = read_sf("./data/processed/brandenburg_landkreise_id_25833.gpkg")
plot(shapes)

subdata = data %>% dplyr::filter(nuts_id %in% shapes$NUTS_ID,
                                 type_of_class == "Crop yield losses",
                                 year_date > 2012) %>%
                   dplyr::select(NUTS_ID = nuts_id,
                                 year = year_date,
                                 month = month_date,
                                 MIS) %>% 
                   group_by(year, NUTS_ID) %>% 
                   summarize(impactscore = sum(MIS))

dim(data)
dim(subdata)
colnames(subdata)

head(subdata, 20)

subdata %>% summarize(sum(impactscore))

data %>% dplyr::filter(nuts_id == "DE40",
                       type_of_class == "Crop yield losses",
                       year_date > 2012) %>% 
         dplyr::select(NUTS_ID = nuts_id, 
                       year = year_date,
                       month = month_date,
                       MIS) %>% 
         group_by(year) %>%
         summarize(impactscore = sum(MIS))


test = full_join(shapes, subdata)
plot(test["impactscore"])

write_sf(test, "./data/processed/newspaper_yieldloss.gpkg", driver="GPKG")
write.csv(subdata, "./data/processed/newspaper_yieldloss.csv")
