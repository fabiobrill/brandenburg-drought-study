# the extraction of crop model results has to be conducted using
# only the shapes (fields) of the respective crops in a given year

library(terra)
library(sf)
library(dplyr)

# get EPSG number
getEPSG = function(v){
return(paste0("EPSG:",
              gsub("[^0-9]", "", 
                   last(strsplit(st_crs(v)$wkt, split="EPSG")[[1]])))
)
}

setwd("./data")
lk = read_sf("./processed/brandenburg_landkreise_id_25833.gpkg") %>% st_transform(4326)

for (yoi in 2013:2022){
  for (coi in c("wheat", "rye", "maize", "barley")){
    print(paste(yoi, coi))
    matching = case_when(
      coi == "wheat" ~ "winter_wheat",
      coi == "rye" ~ "rye", # winter_rye
      coi == "maize" ~ "grain_maize",
      coi == "barley" ~ "winter_barley"
    )

    rfile_pp = paste0("./raw/crop_model/yields_brandenburg/raster_year_pp/", coi, "/", yoi, ".tiff")
    rfile_wlp = paste0("./raw/crop_model/yields_brandenburg/raster_year_wlp/", coi, "/", yoi, ".tiff")

    vname = paste0("./intermediate/indicators_on_exposure_", yoi, ".gpkg")
    outname = paste0("./intermediate/cropmodel_", coi, "_", yoi, ".gpkg")
    shapes = read_sf(vname) %>% st_transform("EPSG:4326") # much faster in extraction
    shapes = shapes %>% filter(crop == matching)

    # kick out invalid polygons - should not be any after 2013, but just to make sure
    idx = which(st_is_valid(shapes)) 
    shapes = shapes[idx,]
    epsg = getEPSG(shapes)
    rname_pp = "modelled_pp"
    rname_wlp = "modelled_wlp"
    r_pp = rast(rfile_pp)
    r_wlp = rast(rfile_wlp)

    # extract pp
    x = terra::extract(r_pp, shapes[1], fun=mean,
                        na.rm=T, exact=F, ID=F, raw=T)
    shapes[rname_pp] = round(x[,1]/100, 2)

    # extract wlp
    x = terra::extract(r_wlp, shapes[1], fun=mean,
                        na.rm=T, exact=F, ID=F, raw=T)
    shapes[rname_wlp] = round(x[,1]/100, 2)

    df = shapes %>% as.data.frame() %>% select(-geom)

    shapes["modelled_yield_pp"] = df[rname_pp]*df["area_iacs"]
    shapes["modelled_yield_wlp"] = df[rname_wlp]*df["area_iacs"]

    write_sf(shapes, outname, driver="GPKG")

    # aggregate on landkreis level
    aggregated = shapes %>% as.data.frame() %>% 
                            select(-geom) %>%
                            group_by(NUTS_ID) %>%
                            summarize(NUTS_NAME = first(NUTS_NAME),
                                      crop = first(crop),
                                      #year = first(year),
                                      year = yoi,
                                      expected_dtha = mean(expected_dtha, na.rm=T),
                                      yield_expected = sum(yield_expected, na.rm=T),
                                      modelled_pp = mean(modelled_pp, na.rm=T),
                                      modelled_wlp = mean(modelled_wlp, na.rm=T),
                                      modelled_yield_pp = sum(modelled_yield_pp, na.rm=T),
                                      modelled_yield_wlp = sum(modelled_yield_wlp, na.rm=T))

    left_join(lk, aggregated) %>% 
      write_sf(gsub(".gpkg", "_aggregated.gpkg", outname, fixed=T), driver="GPKG")

  }
}


# merge
for (coi in c("wheat", "rye", "maize", "barley")){
  merged = read_sf(paste0("./intermediate/cropmodel_", coi, "_2013.gpkg"))
  colnames(merged)[startsWith(colnames(merged), "price")] = "price"
  merged$year = 2013
  for (yoi in 2014:2022){
    print(paste(yoi, coi))
    temp = read_sf(paste0("./intermediate/cropmodel_", coi, "_", yoi, ".gpkg"))
    colnames(temp)[startsWith(colnames(temp), "price")] = "price"
    temp$year = yoi
    merged = rbind(merged, temp)
  }

  # uppercase
  #colnames(merged)[colnames(merged)=="azl"] = "AZL"
  #colnames(merged)[colnames(merged)=="lbg"] = "LBG"
  #colnames(merged)[colnames(merged)=="TWI"] = "TWI"
  #colnames(merged)[colnames(merged)=="NFK"] = "NFK"

  write_sf(merged, paste0("./processed/cropmodel_", coi, ".gpkg"), driver="GPKG")
  write.csv(merged %>% as.data.frame() %>% select(-geom), 
            paste0("./processed/cropmodel_", coi, ".csv"), row.names=F)
}